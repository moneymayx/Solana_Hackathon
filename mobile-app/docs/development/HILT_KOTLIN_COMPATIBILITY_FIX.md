# Hilt + Kotlin Metadata Compatibility Fix

## The Problem

### Error Message
```
Execution failed for task ':app:hiltJavaCompileDebug'.
> java.lang.IllegalStateException: Unable to read Kotlin metadata due to unsupported metadata version.
```

### Root Cause
This error occurs when:
1. **Kotlin version is too new** for the annotation processor
2. **Gradle cache contains old metadata** that conflicts with new versions
3. **Hilt's Java compiler stage** can't read Kotlin metadata generated by KSP

### Why It Was Persisting
Even after "Invalidate Caches & Restart" in Android Studio, the error persisted because:
- Android Studio's cache invalidation **doesn't clear** `.gradle/` build cache
- Tasks marked `FROM-CACHE` were reusing incompatible cached metadata
- File permission issues prevented manual deletion of cache directories

## The Solution: Downgrade to Kotlin 2.0.21

### What Changed
```kotlin
// BEFORE (Kotlin 2.1.0 - bleeding edge, unstable with Hilt)
id("org.jetbrains.kotlin.android") version "2.1.0" apply false
id("org.jetbrains.kotlin.plugin.compose") version "2.1.0" apply false
id("com.google.devtools.ksp") version "2.1.0-1.0.29" apply false

// AFTER (Kotlin 2.0.21 - stable, proven compatibility)
id("org.jetbrains.kotlin.android") version "2.0.21" apply false
id("org.jetbrains.kotlin.plugin.compose") version "2.0.21" apply false
id("com.google.devtools.ksp") version "2.0.21-1.0.27" apply false
```

### Why Kotlin 2.0.21?

| Version | Status | Hilt Compatibility | Reason |
|---------|--------|-------------------|--------|
| **2.0.21** | ✅ Stable | Perfect | Last stable release before 2.1.0, thoroughly tested with Hilt 2.52 |
| 2.1.0 | ⚠️ Bleeding Edge | Partial | Metadata format changes cause compatibility issues with annotation processors |
| 1.9.x | ⚠️ Outdated | Good | Too old, missing Compose compiler improvements |

### Compatibility Matrix

```
✅ WORKING CONFIGURATION:
Kotlin:          2.0.21
KSP:             2.0.21-1.0.27  (matches Kotlin version)
Hilt:            2.52           (latest stable)
AGP:             8.3.0          (Android Gradle Plugin)
Compose Kotlin:  2.0.21         (matches Kotlin version)
```

## Why Version Downgrades Are Sometimes Necessary

1. **Annotation Processing Complexity**: Hilt needs to read Kotlin metadata generated by the compiler. New Kotlin versions introduce metadata format changes.

2. **JVM Bytecode Compatibility**: Hilt's Java annotation processor runs in a different compilation phase than Kotlin, creating a synchronization challenge.

3. **Ecosystem Lag**: Even when Hilt claims support for a Kotlin version, edge cases and caching issues can arise in complex projects.

4. **Compose Compiler**: Using stable versions ensures the Compose compiler plugin is also battle-tested.

## Next Steps

### In Android Studio

1. **Sync Project with Gradle Files**
   - Click the "Sync Now" banner that appears
   - Or: `File` → `Sync Project with Gradle Files`

2. **Clean Build** (Critical!)
   ```
   Build → Clean Project
   ```
   Wait for completion

3. **Rebuild Project**
   ```
   Build → Rebuild Project
   ```

4. **Run the App**
   - The build should succeed this time
   - New cache will be generated with compatible metadata

### Expected Build Output

After downgrading, you should see:
```
> Task :app:kspDebugKotlin          // KSP processes annotations
> Task :app:compileDebugKotlin      // Kotlin compilation
> Task :app:hiltAggregateDepsDebug  // Hilt aggregates dependencies
> Task :app:hiltJavaCompileDebug    // ✅ Should succeed now!
> Task :app:assembleDebug           // ✅ Build complete
```

## Future: When to Upgrade

**Wait to upgrade Kotlin 2.1.x until:**
1. ✅ Hilt releases a version explicitly stating "Full Kotlin 2.1.x support"
2. ✅ Community reports confirm stable builds in production
3. ✅ Your specific dependency combination is tested (Compose + Hilt + KSP)
4. ✅ At least 2-3 months have passed since 2.1.x release

**Monitor these sources:**
- [Hilt Release Notes](https://github.com/google/dagger/releases)
- [Kotlin Release Blog](https://kotlinlang.org/docs/releases.html)
- [Android Developer Updates](https://developer.android.com/jetpack/androidx/releases/hilt)

## Alternative Solutions (If Kotlin 2.0.21 Doesn't Work)

### Option 2: Upgrade AGP (if on newer Kotlin)
```kotlin
// Requires more extensive testing
id("com.android.application") version "8.7.3" apply false
```

### Option 3: Wait for Hilt 2.53+
Future Hilt versions will have better Kotlin 2.1.x support.

### Option 4: Use KAPT instead of KSP
```kotlin
// Not recommended - KAPT is slower and being deprecated
plugins {
    kotlin("kapt")
}
```

## Verification Checklist

After applying this fix:
- [ ] Gradle sync completes successfully
- [ ] Clean build succeeds
- [ ] No "metadata version" errors
- [ ] App runs on device/emulator
- [ ] Wallet connection works (our main feature)
- [ ] No new Compose compilation warnings

## Related Files Modified
- `/build.gradle.kts` (project-level) - Kotlin and KSP versions

## References
- [Kotlin 2.0.21 Release](https://github.com/JetBrains/kotlin/releases/tag/v2.0.21)
- [KSP Version Compatibility](https://github.com/google/ksp/releases)
- [Hilt Kotlin Support](https://dagger.dev/dev-guide/ksp)

